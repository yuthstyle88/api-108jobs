name: Build & Deploy 108jobs API

on:
  push:
    branches: [ "main" ] # or "master"

jobs:
  deploy:
    runs-on: ubuntu-latest

    env:
      BASE_NAME: lemmy_server
      APP_PATH: ${{ vars.APP_PATH }} # e.g., /var/www/apps

    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4

      # This will automatically install Rust 1.84.1 as specified in rust-toolchain.toml
      - name: ðŸ¦€ Setup Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Set APP_NAME
        run: echo "APP_NAME=${{ env.BASE_NAME }}-prod" >> $GITHUB_ENV

      - name: ðŸ› ï¸ Build app
        run: |
          mkdir -p bin
          cargo build --release --bin ${{ env.BASE_NAME }}
          cp target/release/${{ env.BASE_NAME }} bin/${{ env.APP_NAME }}
          chmod +x bin/${{ env.APP_NAME }}

      - name: ðŸ” Setup SSH Agent
        uses: webfactory/ssh-agent@v0.9.1
        with:
          ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY }}

      - name: ðŸ—ï¸ Add SSH host key to known_hosts
        run: |
          mkdir -p ~/.ssh
          ssh-keyscan -p ${{ secrets.SSH_PORT }} ${{ secrets.SSH_HOST }} >> ~/.ssh/known_hosts

      - name: ðŸš€ Deploy & Restart Service
        run: |
          ssh -p ${{ secrets.SSH_PORT }} ${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST }} << 'EOF'
            set -euo pipefail
            APP_DIR="${{ env.APP_PATH }}"
            SVC="fastwork-api.service"

            mkdir -p "$APP_DIR"

            echo "=== Stop service if active ==="
            if sudo -n systemctl is-active --quiet "$SVC"; then
              sudo -n systemctl stop "$SVC"
            fi

            echo "=== Remove old binary (keep ~/config.hjson) ==="
            rm -f "$APP_DIR/${{ env.APP_NAME }}" || true
            ls -ld "$APP_DIR" || true
          EOF

          echo "=== Copy new binary to server ==="
          scp -P ${{ secrets.SSH_PORT }} \
            bin/${{ env.APP_NAME }} \
            ${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST }}:"${{ env.APP_PATH }}/"

          ssh -p ${{ secrets.SSH_PORT }} ${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST }} << 'EOF'
            set -euo pipefail
            APP_DIR="${{ env.APP_PATH }}"
            APP_BIN="${{ env.APP_NAME }}"
            SVC="fastwork-api.service"

            cd "$APP_DIR"
            sudo -n chown www-data:www-data "$APP_BIN" || true
            sudo -n chmod 775 "$APP_BIN" || true

            echo "Reload systemd"
            sudo -n systemctl daemon-reload

            echo "Start service"
            sudo -n systemctl restart "$SVC"

            echo "Check status"
            sudo -n systemctl --no-pager -l status "$SVC" | head -n 30
          EOF
