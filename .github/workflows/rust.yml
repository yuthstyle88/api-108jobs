name: Build & Deploy Rust App

on:
  push:
    branches: [ "prod", "dev" ]  # ðŸ‘ˆ à¹€à¸žà¸´à¹ˆà¸¡ dev branch
  workflow_dispatch: {}

jobs:
  deploy:
    runs-on: ubuntu-latest

    env:
      BASE_NAME: app_108jobs_api_server
      SERVICE_NAME: app-108jobs-api-server
      APP_PORT: 8100
      APP_PATH: ${{ vars.APP_PATH }}

    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: Set APP_NAME
        run: echo "APP_NAME=${{ env.BASE_NAME }}_${{ github.ref_name }}" >> $GITHUB_ENV

      - name: ðŸ” Setup SSH
        uses: webfactory/ssh-agent@v0.9.1
        with:
          ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY }}

      - name: ðŸ—ï¸ Add SSH host key to known_hosts
        run: |
          mkdir -p ~/.ssh
          ssh-keyscan -p ${{ secrets.SSH_PORT }} ${{ secrets.SSH_HOST }} >> ~/.ssh/known_hosts

      - name: ðŸš€ Build & Deploy directly on server
        run: |
          set -e
          echo "Build and Deploy on remote server..."
          ssh -p ${{ secrets.SSH_PORT }} ${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST }} "
            set -e;
            BRANCH='${{ github.ref_name }}';
            echo 'Ensure app path exists';
            mkdir -p '${{ env.APP_PATH }}';
            cd '${{ env.APP_PATH }}';

            echo 'Fetch source (branch $BRANCH)';
            if [ ! -d .git ]; then
              git clone -b $BRANCH git@github.com:yuthstyle88/fast-work-new.git .;
            else
              git fetch --all --prune;
              git checkout $BRANCH;
              git pull --ff-only origin $BRANCH;
            fi

            echo 'Build binary for branch: $BRANCH';
            cargo build --release --bin ${{ env.BASE_NAME }};

            TARGET_NAME='${{ env.BASE_NAME }}_${BRANCH}';
            cp target/release/${{ env.BASE_NAME }} \"${{ env.APP_PATH }}/$TARGET_NAME\";
            chmod 775 \"${{ env.APP_PATH }}/$TARGET_NAME\";

            echo 'Restart systemd service if main branch';
            if [ \"$BRANCH\" = \"main\" ]; then
              sudo -n systemctl daemon-reload;
              sudo -n systemctl restart ${{ env.SERVICE_NAME }}.service;
              sudo -n systemctl --no-pager -l status ${{ env.SERVICE_NAME }}.service | head -n 40;
            else
              echo 'Skip restart (dev branch)';
            fi
          "
