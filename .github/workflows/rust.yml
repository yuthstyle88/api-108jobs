name: Build & Deploy Rust App

on:
  push:
    branches: [ "prod", "dev" ]  # ðŸ‘ˆ à¹€à¸žà¸´à¹ˆà¸¡ dev branch
  workflow_dispatch: {}

jobs:
  deploy:
    runs-on: ubuntu-latest

    env:
      BASE_NAME: app_108jobs_api_server
      SERVICE_NAME: app-108jobs-api-server
      APP_PORT: 8100
      APP_PATH: ${{ vars.APP_PATH }}
      BRANCH: ${{ github.ref_name }}
    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: Set APP_NAME
        run: echo "APP_NAME=${{ env.BASE_NAME }}_${{ env.BRANCH }}" >> $GITHUB_ENV

      - name: ðŸ” Setup SSH
        uses: webfactory/ssh-agent@v0.9.1
        with:
          ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY }}

      - name: ðŸ—ï¸ Add SSH host key to known_hosts
        run: |
          mkdir -p ~/.ssh
          ssh-keyscan -p ${{ secrets.SSH_PORT }} ${{ secrets.SSH_HOST }} >> ~/.ssh/known_hosts

      - name: ðŸš€ Build & Deploy directly on server
        run: |
          set -euo pipefail
          echo "Build and Deploy on remote server..."
          ssh -p ${{ secrets.SSH_PORT }} ${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST }} "
            set -euo pipefail;
            echo 'Ensure app path exists';
            mkdir -p '${{ env.APP_PATH }}';
            cd '${{ env.APP_PATH }}';

            echo 'Fetch source (branch ${{ env.BRANCH }})';
            if [ ! -d .git ]; then
              git clone -b ${{ env.BRANCH }} git@github.com:yuthstyle88/fast-work-new.git .;
            else
              git fetch --all --prune;
              git checkout ${{ env.BRANCH }};
              git pull --ff-only origin ${{ env.BRANCH }};
            fi

            echo 'Build binary for branch: ${{ env.BRANCH }}';
            cargo build --release --bin ${{ env.BASE_NAME }};

            cp target/release/${{ env.BASE_NAME }} \"${{ env.APP_PATH }}/${{ env.BASE_NAME }}_${{ env.BRANCH }}\";
            chmod 775 \"${{ env.APP_PATH }}/${{ env.BASE_NAME }}_${{ env.BRANCH }}\";

            echo 'Restart systemd service if prod branch';
            if [ \"${{ env.BRANCH }}\" = \"prod\" ]; then
              sudo -n systemctl daemon-reload;
              sudo -n systemctl restart ${{ env.SERVICE_NAME }}.service;
              sudo -n systemctl --no-pager -l status ${{ env.SERVICE_NAME }}.service | head -n 40;
            else
              echo 'Skip restart (dev branch)';
            fi
          "
