name: Build & Deploy Rust App

on:
  push:
    branches: [ "main" ]
  workflow_dispatch: {}

jobs:
  deploy:
    runs-on: ubuntu-latest

    env:
      BASE_NAME: app-108jobs-api-server
      APP_PORT: 8100
      APP_PATH: ${{ vars.APP_PATH }}

    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: Set APP_NAME
        run: echo "APP_NAME=${{ env.BASE_NAME }}-prod" >> $GITHUB_ENV

      - name: ðŸ” Setup SSH
        uses: webfactory/ssh-agent@v0.9.1
        with:
          ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY }}

      - name: ðŸ—ï¸ Add SSH host key to known_hosts
        run: |
          mkdir -p ~/.ssh
          ssh-keyscan -p ${{ secrets.SSH_PORT }} ${{ secrets.SSH_HOST }} >> ~/.ssh/known_hosts

      - name: ðŸš€ Build & Deploy directly on server
        run: |
          set -e
          echo "Build and Deploy on remote server..."
          ssh -p ${{ secrets.SSH_PORT }} ${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST }} "
            set -e;
            echo 'Ensure app path exists';
            mkdir -p '${{ env.APP_PATH }}';
            cd '${{ env.APP_PATH }}';
            echo 'Configure SSH for GitHub on server';
            mkdir -p ~/.ssh;
            chmod 700 ~/.ssh;
            printf '%s\n' \
            'Host github.com' \
            '  HostName github.com' \
            '  User git' \
            '  Port 22' \
            '  StrictHostKeyChecking accept-new' \
            '  IdentityFile ~/.ssh/id_ed25519' \
            '  IdentityFile ~/.ssh/id_ed25519_translate' \
            '  IdentitiesOnly yes' > ~/.ssh/config;
            chmod 600 ~/.ssh/config;
            ssh-keyscan github.com >> ~/.ssh/known_hosts 2>/dev/null || true;

            echo 'Fetch latest source (SSH)';
            if [ ! -d .git ]; then
              git clone git@github.com:yuthstyle88/fast-work-new.git .;
            else
              git remote set-url origin git@github.com:yuthstyle88/fast-work-new.git || true;
              git fetch --all --prune;
              git checkout main;
              git pull --ff-only origin main;
            fi

            echo 'Sync translate subrepository into crates/email/src/translations';
            rm -rf crates/email/src/translations;
            /usr/bin/env bash -c '
              set -e
              if git ls-remote git@github.com:yuthstyle88/translate.git >/dev/null 2>&1; then
                git clone git@github.com:yuthstyle88/translate.git /tmp/translate
              else
                echo "SSH to translate denied; trying HTTPS with token..."
                git clone "https://${{ secrets.GH_PAT_DEPLOY }}@github.com/yuthstyle88/translate.git" /tmp/translate
              fi
            '
            mkdir -p crates/email/src/translations;
            cp -r /tmp/translate/email/* crates/email/src/translations/ || true;

            echo 'Build release binary';
            cargo build --release --bin ${{ env.BASE_NAME }};

            echo 'Prepare config path and permissions';
            mkdir -p config;
            [ -f config/config.hjson ] || echo '{}' > config/config.hjson;
            chmod 664 config/config.hjson || true;

            echo 'Restart systemd service';
            if sudo -n -v 2>/dev/null; then
              sudo -n systemctl daemon-reload;
              sudo -n systemctl restart ${{ env.BASE_NAME }}.service;
              sudo -n systemctl --no-pager -l status ${{ env.BASE_NAME }}.service | head -n 40;
            else
              echo 'skip restart (no sudo NOPASSWD)';
            fi
          "