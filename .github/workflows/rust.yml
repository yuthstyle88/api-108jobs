name: Build & Deploy Rust App

on:
  push:
    branches: [ "main" ]
  workflow_dispatch: {}

jobs:
  deploy:
    runs-on: ubuntu-latest

    env:
      BASE_NAME: app-108jobs-api-server
      APP_PORT: 8100
      APP_PATH: ${{ vars.APP_PATH }}

    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: Install clang & lld
        run: sudo apt-get update && sudo apt-get install -y clang lld

      - name: ðŸ¦€ Setup Rust
        uses: dtolnay/rust-toolchain@stable

      # â¬‡â¬‡ à¸ªà¸³à¸„à¸±à¸: à¸šà¸±à¸‡à¸„à¸±à¸šà¹ƒà¸Šà¹‰ lld à¹à¸¥à¸° clang à¸ªà¸³à¸«à¸£à¸±à¸š target linux â¬‡â¬‡
      - name: Force lld linker (override project config)
        run: |
          echo 'CARGO_TARGET_X86_64_UNKNOWN_LINUX_GNU_LINKER=clang' >> $GITHUB_ENV
          echo 'CARGO_TARGET_X86_64_UNKNOWN_LINUX_GNU_RUSTFLAGS=-C link-arg=-fuse-ld=lld' >> $GITHUB_ENV

      - name: Set APP_NAME
        run: echo "APP_NAME=${{ env.BASE_NAME }}-prod" >> $GITHUB_ENV

      - name: ðŸ› ï¸ Build app and define APP_NAME
        run: |
          mkdir -p bin
          cargo build --release --bin ${{ env.BASE_NAME }}
          cp target/release/${{ env.BASE_NAME }} bin/${{ env.APP_NAME }}
          chmod +x bin/${{ env.APP_NAME }}

      - name: ðŸ” Setup SSH
        uses: webfactory/ssh-agent@v0.9.1
        with:
          ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY }}

      - name: ðŸ—ï¸ Add SSH host key to known_hosts
        run: |
          mkdir -p ~/.ssh
          ssh-keyscan -p ${{ secrets.SSH_PORT }} ${{ secrets.SSH_HOST }} >> ~/.ssh/known_hosts

      - name: ðŸš€ Restart app on server (Rust)
        run: |
          set -e
          echo "Start Deploy to Server" 
          ssh -p ${{ secrets.SSH_PORT }} ${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST }} \
            "set -e; \
             mkdir -p '${{ env.APP_PATH }}/config'; \
             if sudo -n -v 2>/dev/null && sudo -n systemctl is-active --quiet ${{ env.BASE_NAME }}.service; then \
               sudo -n systemctl stop ${{ env.BASE_NAME }}.service; \
             fi; \
             rm -f '${{ env.APP_PATH }}/config/config.hjson' '${{ env.APP_PATH }}/${{ env.APP_NAME }}' || true"

          echo "Copy file to Server Deploy"
          scp -P ${{ secrets.SSH_PORT }} \
            config/config.hjson \
            bin/${{ env.APP_NAME }} \
            ${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST }}:"${{ env.APP_PATH }}/"

          # à¸¢à¹‰à¸²à¸¢ config à¹„à¸›à¹„à¸§à¹‰à¹ƒà¸™à¹‚à¸Ÿà¸¥à¹€à¸”à¸­à¸£à¹Œ config/ à¹ƒà¸«à¹‰à¸–à¸¹à¸à¸•à¸³à¹à¸«à¸™à¹ˆà¸‡
          ssh -p ${{ secrets.SSH_PORT }} ${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST }} \
            "set -e; \
             mv -f '${{ env.APP_PATH }}/config.hjson' '${{ env.APP_PATH }}/config/config.hjson' || true; \
             cd '${{ env.APP_PATH }}'; \
             chmod 664 config/config.hjson || true; \
             chmod 775 '${{ env.APP_NAME }}' || true; \
             if sudo -n -v 2>/dev/null; then \
               sudo -n systemctl daemon-reload; \
               sudo -n systemctl restart ${{ env.BASE_NAME }}.service; \
               sudo -n systemctl --no-pager -l status ${{ env.BASE_NAME }}.service | head -n 20; \
             else \
               echo 'skip restart (no sudo NOPASSWD)'; \
             fi"